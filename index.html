<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Subscription</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .subscriber-table {
        display: none;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <!-- Subscribe Form -->
      <div class="row justify-content-center mb-5">
        <div class="col-md-6">
          <div class="card shadow">
            <div class="card-body">
              <h2 class="card-title text-center mb-4">
                Subscribe to Our Newsletter
              </h2>
              <form id="subscribeForm" class="needs-validation" novalidate>
                <div class="mb-3">
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    placeholder="Enter your email"
                    required
                  />
                </div>
                <button type="submit" class="btn btn-primary w-100">
                  Subscribe
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- View Subscribers Button -->
      <div class="row justify-content-center mb-3">
        <div class="col-md-6 text-center">
          <button id="viewSubscribers" class="btn btn-secondary">
            View Subscribers
          </button>
        </div>
      </div>

      <!-- Subscribers Table -->
      <div
        class="row justify-content-center subscriber-table"
        id="subscriberSection"
      >
        <div class="col-md-8">
          <div class="card shadow">
            <div class="card-body">
              <h3 class="card-title mb-4">Subscribers List</h3>
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Email</th>
                    </tr>
                  </thead>
                  <tbody id="subscribersList"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Your existing form submission code
      document
        .getElementById("subscribeForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const email = document.getElementById("email").value;
          // Replace with your Google Apps Script URL for POST
          const SCRIPT_URL =
            "https://script.google.com/macros/s/AKfycbyPO2VTilaueBfeuwlyZuGXwyDd9qDFItqheOfTZsQHHofoLi1Asq0yc0iDmOr6fiJPGA/exec";

          fetch(SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `email=${encodeURIComponent(email)}`,
          })
            .then((response) => {
              if (response.type === "opaque") {
                alert("Thank you for subscribing!");
                document.getElementById("email").value = "";
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("An error occurred. Please try again.");
            });
        });

      // New code to fetch and display subscribers
      document
        .getElementById("viewSubscribers")
        .addEventListener("click", function () {
          // Replace with your Google Apps Script URL for GET
          const GET_URL =
            "https://script.google.com/macros/s/AKfycbyPO2VTilaueBfeuwlyZuGXwyDd9qDFItqheOfTZsQHHofoLi1Asq0yc0iDmOr6fiJPGA/exec";

          // Toggle the visibility of the subscriber section
          const subscriberSection =
            document.getElementById("subscriberSection");

          if (
            subscriberSection.style.display === "none" ||
            subscriberSection.style.display === ""
          ) {
            subscriberSection.style.display = "block";

            // Fetch the data
            fetch(GET_URL)
              .then((response) => response.json())
              .then((data) => {
                const tbody = document.getElementById("subscribersList");
                tbody.innerHTML = ""; // Clear existing content

                // Skip the header row (first row) and create table rows
                data.slice(1).forEach((row) => {
                  const tr = document.createElement("tr");
                  // Format the date
                  const date = new Date(row[0]);
                  const formattedDate =
                    date.toLocaleDateString() + " " + date.toLocaleTimeString();

                  tr.innerHTML = `
                                <td>${formattedDate}</td>
                                <td>${row[1]}</td>
                            `;
                  tbody.appendChild(tr);
                });
              })
              .catch((error) => {
                console.error("Error:", error);
                alert("Error fetching subscribers");
              });
          } else {
            subscriberSection.style.display = "none";
          }
        });
    </script>
  </body>
</html>
